<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Hydraulic Repair Tracker (Light)</title>
  <style>
  /* KPI panel fix */
.kpi-panel {
  padding: 0 16px 10px;
  border-bottom: 1px solid var(--border);
}

.kpi-row {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 12px;
  padding: 14px 16px;
  background: #f8fafc;
  border-bottom: 1px solid var(--border);
}

.kpi-card {
  background: #ffffff;
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 14px;
}

.kpi-title {
  font-size: 12px;
  color: var(--text-muted);
}

.kpi-value {
  font-size: 24px;
  font-weight: 700;
  margin-top: 4px;
}


    :root {
  --primary: #003a8f;        /* Rexroth dark blue */
  --primary-soft: #e8f0fb;
  --accent: #e60028;         /* Rexroth red */
  --accent-soft: #fde7ec;
  --border: #e5e9f0;
  --bg: #f4f7fb;
  --card-bg: #ffffff;
  --text-main: #0f172a;
  --text-muted: #5b6b82;
  --danger: #dc2626;
  --warning: #f59e0b;
}


    * { box-sizing: border-box; }

    body {
  margin: 0;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  background: var(--bg);
  color: var(--text-main);
  min-height: 100vh;
}


.app-shell {
  width: 100%;
  max-width: 1200px;
  margin: 16px auto;
  background: var(--card-bg);
  border-radius: 16px;
  border: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  overflow: hidden; /* IMPORTANT */
}




    header {
      padding: 12px 18px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: linear-gradient(90deg, #eff6ff, #ffffff);
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }
     .logo-icon {
  width: 100px;
  height: 54px;
  border-radius: 6px;
  background: white;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 4px 10px rgba(0,0,0,0.08);
  overflow: hidden;
}

.logo-img img {
  height: 30px;
  width: auto;
  object-fit: contain;
}

    .logo-title { font-size: 16px; font-weight: 600; }
    .logo-sub { font-size: 12px; color: var(--text-muted); }

    .header-right {
      text-align: right;
      font-size: 11px;
      color: var(--text-muted);
    }

 .main {
  display: grid;
  grid-template-columns: 1fr 1.2fr; /* balanced */
  gap: 16px;
  padding: 16px;
  background: #ffffff;
}


.panel {
  background: #ffffff;
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 14px;
  display: flex;
  flex-direction: column;
  gap: 12px;
}

{ padding: 14px 16px; }
    .panel + .panel {
      border-left: 1px solid var(--border);
      background: #fafafa;
    }

    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 8px;
    }
    .panel-header h2 {
      margin: 0;
      font-size: 14px;
      font-weight: 600;
    }
    .hint { font-size: 11px; color: var(--text-muted); }

    .card {
      background: var(--card-bg);
      border-radius: 12px;
      border: 1px solid var(--border);
      padding: 10px 12px;
      margin-bottom: 10px;
    }

    .card-title-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }
    .card-title { font-size: 13px; font-weight: 600; }

    .pill {
      font-size: 10px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #f9fafb;
      color: var(--text-muted);
    }

    label {
      font-size: 11px;
      font-weight: 500;
      color: var(--text-muted);
      margin-bottom: 2px;
      display: block;
    }

    input, select, textarea {
      width: 100%;
      padding: 6px 8px;
      margin-bottom: 8px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: #ffffff;
      font-size: 12px;
      outline: none;
      transition: border-color 0.12s, box-shadow 0.12s, background 0.12s;
    }
    input:focus, select:focus, textarea:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 1px rgba(37,99,235,0.20);
      background: #f9fafb;
    }
    textarea {
      resize: vertical;
      min-height: 50px;
      max-height: 120px;
    }

    .btn {
      border-radius: 999px;
      padding: 7px 14px;
      font-size: 12px;
      cursor: pointer;
      border: 1px solid transparent;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-weight: 500;
    }
    .btn-primary {
      background: linear-gradient(135deg, #2563eb, #3b82f6);
      color: #ffffff;
      border-color: #2563eb;
    }
    .btn-primary:hover { filter: brightness(1.04); }
    .btn-ghost {
      background: #ffffff;
      color: var(--text-muted);
      border-color: var(--border);
    }
    .btn-ghost:hover { background: #f3f4f6; }
    .btn-small { padding: 4px 10px; font-size: 11px; }

    .success-msg {
      font-size: 11px;
      color: var(--accent);
      min-height: 14px;
      margin-top: 4px;
    }

    .filters-row {
      display: flex;
      gap: 6px;
      margin-top: 4px;
      margin-bottom: 6px;
    }
    .filters-row > div { flex: 1; }
    .filters-row select, .filters-row input {
      margin-bottom: 0;
      padding: 5px 8px;
      font-size: 11px;
    }

    /* Ticket list */
    .ticket-list {
      max-height: 320px;
      overflow-y: auto;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #f9fafb;
    }
    .ticket-item {
      padding: 7px 9px;
      border-bottom: 1px solid #e5e7eb;
      cursor: pointer;
      font-size: 12px;
      display: flex;
      flex-direction: column;
      gap: 2px;
      transition: background 0.12s;
    }
    .ticket-item:last-child { border-bottom: none; }
    .ticket-item:hover { background: #eff6ff; }
    .ticket-item.active { background: #e0ecff; }

    .ticket-top-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .ticket-top-left {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .ticket-ref { font-weight: 600; }
    .attach-badge { font-size: 11px; opacity: 0.8; }
    .status-chip {
      padding: 1px 6px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      font-size: 10px;
      background: #f9fafb;
      color: var(--text-muted);
    }
    .ticket-meta {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      color: var(--text-muted);
    }
    .ticket-issue { font-size: 11px; color: var(--text-muted); }

    .priority-dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 4px;
    }
    .prio-low { background: #22c55e; }
    .prio-medium { background: #0ea5e9; }
    .prio-high { background: #f97316; }
    .prio-urgent { background: #ef4444; }

    /* Right side detail */
    .detail-card {
      background: var(--card-bg);
      border-radius: 12px;
      border: 1px solid var(--border);
      padding: 10px 12px;
      height: 100%;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .detail-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      border-bottom: 1px solid #f3f4f6;
      padding-bottom: 6px;
    }
    .detail-header-main { font-size: 14px; font-weight: 600; }

    .badge-status {
      padding: 2px 10px;
      border-radius: 999px;
      border: 1px solid #bfdbfe;
      background: #eff6ff;
      font-size: 11px;
      color: #1d4ed8;
    }

    .detail-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 4px 12px;
      font-size: 11px;
    }
    .detail-label { color: var(--text-muted); }
    .detail-value { font-weight: 500; }

    .issue-box {
      margin-top: 4px;
      padding: 8px;
      border-radius: 8px;
      border: 1px dashed #d1d5db;
      background: #f9fafb;
      font-size: 11px;
      white-space: pre-wrap;
    }

    /* Vertical tracking - simple light */
    .tracking-card {
      margin-top: 6px;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid #dbeafe;
      background: #f3f4ff;
      font-size: 11px;
    }
    .tracking-header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }
    .tracking-title { font-weight: 600; color: #1d4ed8; }
    .tracking-eta { font-size: 11px; color: #4b5563; }
    .tracking-steps { margin-top: 4px; }
    .tracking-step {
      display: flex;
      align-items: flex-start;
      margin-bottom: 4px;
    }
    .tracking-marker {
      width: 16px;
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-right: 8px;
    }
    .tracking-circle {
      width: 12px;
      height: 12px;
      border-radius: 999px;
      border: 2px solid #d1d5db;
      background: #ffffff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 9px;
      color: #ffffff;
    }
    .tracking-line {
      flex: 1;
      width: 2px;
      background: #e5e7eb;
      margin-top: 1px;
    }
    .tracking-labels { flex: 1; }
    .tracking-label-main { font-weight: 500; color: #374151; }
    .tracking-label-sub { font-size: 10px; color: #9ca3af; }

    .tracking-step.done .tracking-circle {
      border-color: var(--accent);
      background: var(--accent);
    }
    .tracking-step.done .tracking-line { background: var(--accent-soft); }
    .tracking-step.current .tracking-circle {
      border-color: var(--accent);
      background: #ffffff;
      color: var(--accent);
    }
    .tracking-step.current .tracking-label-main {
      color: #111827;
      font-weight: 600;
    }

    .detail-actions {
      margin-top: 6px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
      font-size: 11px;
    }
    .select-inline { min-width: 150px; }

    .bottom-row {
      margin-top: 6px;
      display: grid;
      grid-template-columns: minmax(0,1.4fr) minmax(0,1fr);
      gap: 8px;
      flex: 1;
      min-height: 140px;
    }
    .timeline-card, .notif-card {
      border-radius: 10px;
      border: 1px solid var(--border);
      padding: 6px 8px;
      background: #ffffff;
      font-size: 11px;
      overflow-y: auto;
    }

    .timeline-item {
      border-left: 2px solid #bfdbfe;
      padding-left: 6px;
      margin-bottom: 6px;
    }
    .timeline-time { font-size: 10px; color: var(--text-muted); }

    .notif-item {
      border-left: 2px solid #22c55e;
      padding-left: 6px;
      margin-bottom: 6px;
    }

    /* Attachments mini card */
    .attachments-card {
      margin-top: 6px;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #f9fafb;
      font-size: 11px;
    }
    .attachments-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }
    .attach-list {
      margin-top: 4px;
      max-height: 70px;
      overflow-y: auto;
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }
    .attach-chip {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: #ffffff;
      font-size: 10px;
      max-width: 180px;
      cursor: default;
    }
    .attach-chip-name {
      flex: 1;
      min-width: 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .attach-remove {
      cursor: pointer;
      font-size: 11px;
      flex: 0 0 auto;
    }

    /* Analytics card */
    .analytics-metrics {
      font-size: 11px;
      display: grid;
      grid-template-columns: repeat(1, minmax(0,1fr));
      gap: 4px 12px;
      margin-bottom: 6px;
    }
    .parts-list-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 2px;
    }

    /* Preview overlay */
    .preview-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.45);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }
    .preview-inner {
      background: #ffffff;
      border-radius: 12px;
      max-width: 80vw;
      max-height: 80vh;
      padding: 10px 12px;
      box-shadow: 0 20px 40px rgba(15,23,42,0.25);
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .preview-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
      margin-bottom: 4px;
    }
    .preview-title {
      font-weight: 500;
      color: #111827;
      max-width: 40vw;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .preview-actions {
      display: flex;
      gap: 4px;
      align-items: center;
    }
    .preview-body {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .preview-body img,
    .preview-body video {
      max-width: 100%;
      max-height: 70vh;
      border-radius: 8px;
    }

    @media (max-width: 960px) {
      .main { grid-template-columns: 1fr; }
      .panel + .panel {
        border-left: none;
        border-top: 1px solid var(--border);
      }
    }
/* ===== Ticket popup modal ===== */

.modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.45);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 999;
}


.modal-box {
  background: #fff;
  width: 900px;
  max-width: 95vw;
  max-height: 85vh;
  border-radius: 12px;

  display: flex;
  flex-direction: column;

  overflow: hidden;
}


.modal-close {
  float: right;
  font-size: 22px;
  cursor: pointer;
}

.detail-input {
  width: 100%;
  padding: 6px 8px;
  border: 1px solid #d0d7de;
  border-radius: 6px;
}

/* Hide Status & Details from front page */
.panel--status {
  display: none !important;
}
/* Hide Analytics from front page */
.card--analytics {
  display: none !important;
}
/* Sidebar logo fix */
.sidebar-logo {
  width: 180px;
  height: 70px;
  object-fit: contain;
  display: block;
}

/* Layout base */
.layout {
  display: flex;
  min-height: 100vh;
}

/* Sidebar */
.sidebar {
  width: 240px;
  background: #ffffff;
  border-right: 1px solid #e5e7eb;
  padding: 16px;
  flex-shrink: 0;
}

/* Main app */
.app-shell {
  flex: 1;
}
.header-actions {
  display: flex;
  align-items: center;
  gap: 12px;
}
/* Header brand */
.header-brand {
  display: flex;
  align-items: center;
  gap: 12px;
}

.header-logo {
  width: 180px;
  height: 70px;
  object-fit: contain;
}


.header-title {
  font-size: 18px;
  font-weight: 600;
}

/* Vertical body navigation */
.body-nav {
  margin-top: 16px;
  padding-left: 24px;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.body-nav-item {
  font-size: 14px;
  color: var(--text-muted);
  cursor: pointer;
}

.body-nav-item.active,
.body-nav-item:hover {
  color: var(--primary);
  font-weight: 500;
}
/* ===== Ticket Edit Modal (Clean UI) ===== */

.modal-box {
  background: #fff;
  width: 900px;
  max-width: 95vw;
  max-height: 85vh;

  border-radius: 12px;
  padding: 0;

  display: flex;              /* üî• MISSING LINE */
  flex-direction: column;     /* üî• REQUIRED */

  overflow: hidden;
}


.modal-header {
  flex-shrink: 0;
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 14px 18px;
  border-bottom: 1px solid #e5e7eb;
  font-size: 16px;
  font-weight: 600;
}

.modal-body {
  padding: 16px 18px;
  overflow-y: auto;
  max-height: calc(85vh - 120px); /* üî• KEY LINE */
}

.modal-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px 16px;
}

.modal-grid .full {
  grid-column: 1 / -1;
}

.modal-footer {
  position: sticky;
  bottom: 0;

  display: flex;
  justify-content: flex-end;
  gap: 10px;

  padding: 14px 18px;
  border-top: 1px solid #e5e7eb;
  background: #ffffff;

  z-index: 10;
}


.modal-body label {
  font-size: 12px;
  color: #6b7280;
  margin-bottom: 4px;
  display: block;
}

.modal-body input,
.modal-body select,
.modal-body textarea {
  width: 100%;
  padding: 8px 10px;
  border: 1px solid #d1d5db;
  border-radius: 8px;
  font-size: 13px;
}

.modal-body textarea {
  min-height: 90px;
  resize: vertical;
}
.modal-footer .btn {
  min-width: 90px;
}
/* ===== Layout ===== */
.layout {
  display: flex;
  min-height: calc(100vh - 70px); /* below header */
}

/* ===== Sidebar ===== */
.sidebar {
  width: 220px;
  padding: 20px 16px;
  border-right: 1px solid var(--border);
  background: #ffffff;
  display: flex;
  flex-direction: column;
  gap: 14px;
}

/* ===== Sidebar Tabs ===== */
.side-tab {
  background: none;
  border: none;
  text-align: left;
  font-size: 15px;
  padding: 6px 4px;
  cursor: pointer;
  color: #64748b;
}

.side-tab:hover {
  color: var(--primary);
}

.side-tab.active {
  color: #2563eb;
  font-weight: 600;
}

/* ===== Content Area ===== */
.content {
  flex: 1;
  padding: 20px 24px;
  background: var(--bg);
}

/* ===== Tab Panels ===== */
.tab-panel {
  display: none;
}

.tab-panel.active {
  display: block;
} 
.create-ticket-header {
  display: flex;
  justify-content: flex-end;
  margin-bottom: 12px;
}
.create-ticket-card {
  padding: 16px;
}

.create-ticket-content {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 16px;
}

.create-ticket-text .card-title {
  font-size: 15px;
  font-weight: 600;
}

.create-ticket-text .hint {
  font-size: 12px;
  margin-top: 4px;
  color: var(--text-muted);
}
 /* Remove the big New Repair Ticket container box */
.panel--details > .card:first-of-type {
  border: none !important;
  background: transparent !important;
  box-shadow: none !important;
  padding: 0 !important;
}
.panel--details .create-ticket-card {
  border: none !important;
  background: transparent !important;
  box-shadow: none !important;
}

.panel--details .create-ticket-card {
  padding: 0 !important;
}
/* ===== DASHBOARD KPI ROW ===== */
.dashboard-kpis {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 16px;
  margin-bottom: 20px;
}

.kpi-card {
  background: #ffffff;
  border: 1px solid #e5e7eb;
  border-radius: 14px;
  padding: 18px 20px;
  min-height: 96px;

  display: flex;
  flex-direction: column;
  justify-content: center;

  box-shadow: 0 6px 16px rgba(15, 23, 42, 0.06);
}

.kpi-title {
  font-size: 12px;
  font-weight: 500;
  color: #64748b;
  margin-bottom: 6px;
}

.kpi-value {
  font-size: 28px;
  font-weight: 700;
  color: #0f172a;
}

/* Color accents */
.kpi-card.total    
.kpi-card.open     
.kpi-card.progress 
.kpi-card.closed   

/* Responsive (mobile only) */
@media (max-width: 900px) {
  .dashboard-kpis {
    grid-template-columns: repeat(2, 1fr);
  }
}
@media (max-width: 520px) {
  .dashboard-kpis {
    grid-template-columns: 1fr;
  }
}
.dashboard-charts {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
  margin-top: 20px;
}

.chart-card {
  background: #ffffff;
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 16px;
}

.chart-title {
  font-size: 13px;
  font-weight: 600;
  margin-bottom: 10px;
}
/* ===== Sync LED ===== */
.led {
  width: 7px;
  height: 7px;
  border-radius: 50%;
  margin-left: px;
  box-shadow: 0 0 4px rgba(0,0,0,0.4);
}

/* States */
.led-idle {
  background: #9ca3af; /* gray */
}

.led-sending {
  background: #facc15; /* yellow */
  animation: blink 1s infinite;
}

.led-success {
  background: #22c55e; /* green */
  box-shadow: 0 0 8px #22c55e;
}

.led-error {
  background: #ef4444; /* red */
  box-shadow: 0 0 8px #ef4444;
}

/* Blink animation */
@keyframes blink {
  0% { opacity: 1; }
  50% { opacity: 0.3; }
  100% { opacity: 1; }
}
.repair-journey {
  display: flex;
  gap: 12px;
  align-items: center;
  margin-bottom: 12px;
}

.journey-step {
  display: flex;
  flex-direction: column;
  align-items: center;
  font-size: 11px;
  color: #6b7280;
}

.journey-circle {
  width: 26px;
  height: 26px;
  border-radius: 50%;
  border: 2px solid #d1d5db;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 600;
  background: #fff;
}

.journey-step.done .journey-circle {
  background: #16a34a;
  border-color: #16a34a;
  color: #fff;
}

.journey-step.current .journey-circle {
  border-color: #2563eb;
  color: #2563eb;
}

.journey-label {
  margin-top: 4px;
  text-align: center;
  max-width: 90px;
}
/* ===== Repair Journey (Branded UI) ===== */

.repair-journey {
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  position: relative;
  margin: 8px 0 24px;
  padding: 0 6px;
}

/* background line */
.repair-journey::before {
  content: "";
  position: absolute;
  top: 18px;
  left: 0;
  right: 0;
  height: 3px;
  background: #e5e9f0;
  z-index: 0;
}

.journey-step {
  position: relative;
  z-index: 1;
  width: 100%;
  text-align: center;
  font-size: 12px;
  color: #94a3b8;
  cursor: default;
}

.journey-circle {
  width: 34px;
  height: 34px;
  border-radius: 50%;
  border: 2px solid #cbd5e1;
  background: #ffffff;
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 0 auto 6px;
  font-weight: 600;
  color: #64748b;
  transition: all 0.2s ease;
}

/* completed steps */
.journey-step.done .journey-circle {
  background: #2563eb;
  border-color: #2563eb;
  color: #ffffff;
}

.journey-step.done {
  color: #1e40af;
}

/* current step */
.journey-step.current .journey-circle {
  border-color: #2563eb;
  background: #ffffff;
  color: #2563eb;
  box-shadow: 0 0 0 4px rgba(37,99,235,0.15);
}

.journey-step.current {
  color: #1e293b;
  font-weight: 600;
}

/* hover hint (future use) */
.journey-step:hover .journey-circle {
  transform: scale(1.05);
}
/* ===== Coinbase Button 26 (EXACT) ===== */

.button-26 {
  appearance: button;
  background-color: #1652F0;
  border: 1px solid #1652F0;
  border-radius: 4px;
  box-sizing: border-box;
  color: #FFFFFF;
  cursor: pointer;
  font-family: Graphik,-apple-system,system-ui,"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Fira Sans","Droid Sans","Helvetica Neue",sans-serif;
  font-size: 14px;
  line-height: 1.15;
  overflow: visible;
  padding: 12px 16px;
  position: relative;
  text-align: center;
  text-transform: none;
  transition: all 80ms ease-in-out;
  user-select: none;
  -webkit-user-select: none;
  touch-action: manipulation;
  width: fit-content;
}

.button-26:disabled {
  opacity: .5;
}

.button-26:focus {
  outline: 0;
}

.button-26:hover {
  background-color: #0A46E4;
  border-color: #0A46E4;
}

.button-26:active {
  background-color: #0039D7;
  border-color: #0039D7;
}
/* ===== Premium SaaS Attachment Button ===== */

.premium-attach-btn {
  display: inline-flex;
  align-items: center;
  gap: 10px;

  background: #ffffff;
  border: 1px solid #e5e7eb;

  color: #111827;
  font-size: 13px;
  font-weight: 500;

  padding: 7px 16px;
  border-radius: 10px;

  cursor: pointer;
  transition: all 0.25s ease;

  box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
}

.premium-attach-btn:hover {
  background: #f9fafb;
  border-color: #d1d5db;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
}

.premium-attach-btn:active {
  transform: translateY(1px);
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
}

.attach-plus {
  font-size: 16px;
  font-weight: 600;
  color: #4f46e5;
}
.premium-attach-btn:hover .attach-plus {
  color: #3730a3;
}
/* ===== Attachment Viewer ===== */

.viewer-overlay {
  position: fixed;
  inset: 0;
  background: rgba(15, 23, 42, 0.75);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}

.viewer-content {
  background: #ffffff;
  width: 80%;
  max-width: 900px;
  max-height: 85%;
  border-radius: 12px;
  overflow: hidden;
  position: relative;
  box-shadow: 0 20px 50px rgba(0,0,0,0.2);
}

.viewer-close {
  position: absolute;
  top: 10px;
  right: 14px;
  font-size: 22px;
  cursor: pointer;
  color: #334155;
}

#viewerBody {
  padding: 20px;
  max-height: 80vh;
  overflow: auto;
  text-align: center;
}

#viewerBody img,
#viewerBody video {
  max-width: 100%;
  max-height: 70vh;
  border-radius: 8px;
}
.attachment-row {
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:8px 10px;
  border-bottom:1px solid #eee;
  font-size:13px;
}

.attachment-left {
  display:flex;
  align-items:center;
  gap:8px;
}

.attachment-status {
  font-size:12px;
  color:#64748b;
}

.attach-action {
  cursor:pointer;
  margin-left:10px;
}
.attachment-row{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:8px;
  border-bottom:1px solid #eee;
}

  </style>
</head>
<body>
<input type="hidden" id="__REQUESTDIGEST">

<div class="app-shell">
  <header>
    <div class="header-brand">
  <img
  src="https://download.logo.wine/logo/Bosch_Rexroth/Bosch_Rexroth-Logo.wine.png"
  alt="Bosch Rexroth"
  class="sidebar-logo"
/>

  <span class="header-title">Repair Centre</span>
</div>
   
  <div id="syncLed" class="led led-idle" title="Sync status"></div>

<div class="header-right header-actions">
  <button id="exportCsvBtn" class="button-26">Export</button>
  <button id="importCsvBtn" class="button-26">Import</button>
  <button id="settingsBtn" class="button-26">Settings</button>
</div>

  </header>
  <div class="layout">

  <!-- LEFT SIDEBAR TABS -->
  <aside class="sidebar">
    <button class="side-tab active" data-tab="dashboard">Dashboard</button>
    <button class="side-tab" data-tab="tickets">Tickets</button>
    <button class="side-tab" data-tab="reports">Reports</button>
    <button class="side-tab" data-tab="settings">Settings</button>
  </aside>

  <!-- RIGHT CONTENT -->
  <main class="content">

    <!-- DASHBOARD -->
    <section class="tab-panel active" id="tab-dashboard">
    <!-- ===== DASHBOARD KPI ROW ===== -->
<div class="dashboard-kpis">
  <div class="kpi-card total">
    <div class="kpi-title">Total Tickets</div>
    <div class="kpi-value" id="kpiTotal">0</div>
  </div>

  <div class="kpi-card open">
    <div class="kpi-title">Open Tickets</div>
    <div class="kpi-value" id="kpiOpen">0</div>
  </div>

  <div class="kpi-card progress">
    <div class="kpi-title">In Progress</div>
    <div class="kpi-value" id="kpiProgress">0</div>
  </div>

  <div class="kpi-card closed">
    <div class="kpi-title">Closed Tickets</div>
    <div class="kpi-value" id="kpiClosed">0</div>
  </div>
</div>
<!-- ===== END KPI ROW ===== -->
  <div class="dashboard-charts">
    <div class="chart-card">
      <h3 class="chart-title">Tickets by Status</h3>
      <canvas id="statusChart"></canvas>
    </div>

    <div class="chart-card">
      <h3 class="chart-title">Tickets by Priority</h3>
      <canvas id="priorityChart"></canvas>
    </div>
  </div>

</section>

    <!-- TICKETS -->
    <section class="tab-panel" id="tab-tickets">
      <!-- Create Ticket -->
      <!-- Ticket List -

  <div class="main">
    <header>...</header>

<div class="panel kpi-panel">
  <div class="kpi-row" id="kpiRow">
    <div class="kpi-card">
      <div class="kpi-title">Total Tickets</div>
      <div class="kpi-value" id="kpiTotal">0</div>
    </div>

    <div class="kpi-card blue">
      <div class="kpi-title">Open</div>
      <div class="kpi-value" id="kpiOpen">0</div>
    </div>

    <div class="kpi-card orange">
      <div class="kpi-title">In Progress</div>
      <div class="kpi-value" id="kpiProgress">0</div>
    </div>

    <div class="kpi-card green">
      <div class="kpi-title">Closed</div>
      <div class="kpi-value" id="kpiClosed">0</div>
    </div>
  </div>
</div>

<div class="main">...</div>

    <!-- LEFT -->
    <div class="panel panel--details">

      <div class="panel-header">
        <h2>New Ticket & Jobs</h2>
        <span class="hint">Create ticket ‚Üí Track status</span>
      </div>

        <div class="card card--analytics">

        <div class="card-title-row">
          <div class="card-title">New repair ticket</div>
          <span class="pill">Step 1 ¬∑ Create</span>
        </div>
        
        <label>Component type</label>
        <select id="componentType">
          <option value="Pump">Pump</option>
          <option value="Valve">Valve</option>
          <option value="Cylinder">Cylinder</option>
        </select>

        <label>Serial & model</label>
        <div style="display:flex;gap:6px;">
          <input id="serialInput" placeholder="Serial" />
          <input id="modelInput" placeholder="Model" />
        </div>

        <label>Customer name</label>
        <input id="customerName" placeholder="Customer name" />

        <label>Contact</label>
        <div style="display:flex;gap:6px;">
          <input id="customerEmail" type="email" placeholder="Email" />
          <input id="customerPhone" type="tel" placeholder="Phone" />
        </div>

        <label>Issue</label>
        <textarea id="issueInput" placeholder="Leakage, noise, low pressure, etc."></textarea>

        <label>Failed part / category</label>
        <input id="failedPart" placeholder="e.g. Shaft seal, piston, spool" />

        <label>Priority</label>
        <select id="prioritySelect">
        <option value="Medium">Medium</option>
        <option value="Low">Low</option>
        <option value="High">High</option>
        <option value="Urgent">Urgent</option>

        </select>

        <button class="btn btn-primary" id="createBtn">+ Create ticket</button>
        <div id="createMsg" class="success-msg"></div>
      </div>

      <div class="card">
      <!-- Create Ticket Toggle Button -->
<div class="create-ticket-header">
</div>

<!-- Create Ticket Form (hidden by default) -->
<!-- <div class="card" id="createTicketCard" style="display:none;"> -->

<div class="card create-ticket-card">
  <div class="create-ticket-content">
    <div class="create-ticket-text">
      <div class="card-title">New Repair Ticket</div>
      <div class="hint">
        Create a new service request
      </div>
    </div>

    <button
      type="button"
      class="btn btn-primary"
      id="openCreateTicket"
    >
      + Create Ticket
    </button>
  </div>
</div>


  <!-- ‚úÖ KEEP YOUR EXISTING FORM INSIDE -->
  <!-- componentType, serial, model, etc -->
</div>

        <div class="card-title-row">
          <div class="card-title">Tickets</div>
          <span id="ticketCount" class="hint">0 items</span>
        </div>

        <div class="filters-row">
          <div>
            <label>Status</label>
            <select id="filterStatus"></select>
          </div>
          <div>
            <label>Type</label>
            <select id="filterType">
              <option value="all">All</option>
              <option>Pump</option>
              <option>Valve</option>
              <option>Cylinder</option>
            </select>
          </div>
        </div>
        <div class="filters-row">
          <div style="flex:1;">
            <label>Search</label>
            <input id="searchText" placeholder="Ref, serial, customer..." />
          </div>
          <button class="btn btn-ghost btn-small" id="clearFiltersBtn" style="margin-top:18px;">Clear</button>
        </div>

        <div class="ticket-list" id="ticketList"></div>
      </div>

      <!-- Analytics card -->
      <div class="card card--analytics">

        <div class="card-title-row">
          <div class="card-title">Analytics</div>
          <span class="hint" id="analyticsUpdated"></span>
        </div>
        <div class="analytics-metrics">
          <div>
            <div class="detail-label">Avg repair cost</div>
            <div class="detail-value" id="avgCostValue">‚Äî</div>
          </div>
        </div>
        <div class="hint" style="margin-bottom:2px;">Parts failure trends</div>
        <div id="partsTrends" style="font-size:11px;max-height:90px;overflow-y:auto;border-radius:6px;border:1px solid #e5e7eb;background:#f9fafb;padding:4px 6px;">
          <div class="hint">No data yet.</div>
        </div>
      </div>
    </div>

<!-- Preview overlay -->
<div id="previewOverlay" class="preview-overlay">
  <div class="preview-inner">
    <div class="preview-header">
      <div class="preview-title" id="previewTitle"></div>
      <div class="preview-actions">
        <button id="previewOpen" class="btn btn-ghost btn-small">Open</button>
        <button id="previewDownload" class="btn btn-ghost btn-small">Download</button>
        <button id="previewClose" class="btn btn-ghost btn-small">Close</button>
        <button id="saveBtn" class="btn btn-primary">Save changes</button>
      </div>
    </div>
    <div class="preview-body" id="previewBody"></div>
  </div>
</div>

<script>
// ===== SHAREPOINT SITE URL (SAFE FOR LOCAL + PROD) =====
const SP_SITE_URL =
  typeof _spPageContextInfo !== "undefined"
    ? _spPageContextInfo.webAbsoluteUrl
    : "https://bosch.sharepoint.com/sites/msteams_2f4341df/Lists/SVK/AllItems.aspx?env=WebViewList";
function openAttachmentViewer(url, fileName) {
  const viewer = document.getElementById("attachmentViewer");
  const body = document.getElementById("viewerBody");

  const ext = fileName.split(".").pop().toLowerCase();

  body.innerHTML = "";

  if (["png","jpg","jpeg","gif","webp"].includes(ext)) {
    body.innerHTML = `<img src="${url}" alt="${fileName}" />`;

  } else if (ext === "pdf") {
    body.innerHTML = `
      <iframe src="${url}"
              width="100%"
              height="600px"
              style="border:none;"></iframe>
    `;

  } else if (["mp4","mov","webm"].includes(ext)) {
    body.innerHTML = `
      <video controls>
        <source src="${url}" type="video/mp4">
      </video>
    `;

  } else {
    window.open(url, "_blank");
    return;
  }

  viewer.style.display = "flex";
}

function closeAttachmentViewer() {
  const viewer = document.getElementById("attachmentViewer");
  viewer.style.display = "none";
  document.getElementById("viewerBody").innerHTML = "";
}


function normalizePriority(p) {
  if (!p) return "Medium";

  // SharePoint choice field object case
  if (typeof p === "object" && p.Value) {
    return p.Value;
  }

  // string case
  if (typeof p === "string") {
    return p.charAt(0).toUpperCase() + p.slice(1).toLowerCase();
  }

  return "Medium";
}
function getFileIcon(name) {

  const ext = name.split(".").pop().toLowerCase();

  if (["png","jpg","jpeg","gif","webp"].includes(ext)) {
    return `<svg width="18" height="18" viewBox="0 0 24 24" fill="#22c55e">
      <path d="M21 19V5a2 2 0 0 0-2-2H5C3.9 3 3 3.9 3 5v14a2 2 0 0 0 2 2h14c1.1 0 2-.9 2-2ZM8.5 11.5l2.5 3 3.5-4.5 4.5 6H5l3.5-4.5Z"/>
    </svg>`;
  }

  if (["mp4","mov","webm"].includes(ext)) {
    return `<svg width="18" height="18" viewBox="0 0 24 24" fill="#f97316">
      <path d="M17 10.5V7c0-1.1-.9-2-2-2H5C3.9 5 3 5.9 3 7v10c0 1.1.9 2 2 2h10c1.1 0 2-.9 2-2v-3.5l4 4v-11l-4 4Z"/>
    </svg>`;
  }

  if (["pdf"].includes(ext)) {
    return `<svg width="18" height="18" viewBox="0 0 24 24" fill="#ef4444">
      <path d="M14 2H6a2 2 0 0 0-2 2v16c0 1.1.9 2 2 2h12a2 2 0 0 0 2-2V8l-6-6Z"/>
    </svg>`;
  }

  return `<svg width="18" height="18" viewBox="0 0 24 24" fill="#64748b">
    <path d="M14 2H6a2 2 0 0 0-2 2v16c0 1.1.9 2 2 2h12V8l-4-6Z"/>
  </svg>`;
}

function setLed(state, title = "") {
  const led = document.getElementById("syncLed");
  if (!led) return;

  led.className = "led led-" + state;
  if (title) led.title = title;
}

function ledSending(msg = "Sending data to SharePoint") {
  setLed("sending", msg);
}

function ledSuccess(msg = "Synced successfully") {
  setLed("success", msg);
  setTimeout(() => setLed("idle", "Idle"), 2000);
}

function ledError(msg = "Sync failed") {
  setLed("error", msg);
}

async function loadRequestDigest() {
  const res = await fetch(
    "https://bosch.sharepoint.com/sites/msteams_2f4341df/_api/contextinfo",
    {
      method: "POST",
      headers: {
        "Accept": "application/json;odata=verbose"
      }
    }
  );
  if (!res.ok) {
    throw new Error("Failed to get request digest");
  }
  const data = await res.json();
  document.getElementById("__REQUESTDIGEST").value =
    data.d.GetContextWebInformation.FormDigestValue;
}

function val(id, fallback = "") {
  const el = document.getElementById(id);
  if (!el) return fallback;
  const v = el.value?.trim();
  return v ? v : fallback;
}

   function updateKPIs() {
  const elTotal = document.getElementById("kpiTotal");
  if (!elTotal) return; // ‚õî KPI UI not loaded yet

  const total = tickets.length;
  const open = tickets.filter(t => t.status !== "Closed").length;
  const closed = tickets.filter(t => t.status === "Closed").length;

  const progress = tickets.filter(t =>
    ["Under Inspection","In Repair","Testing"].includes(t.status)
  ).length;

  document.getElementById("kpiTotal").textContent = total;
  document.getElementById("kpiOpen").textContent = open;
  document.getElementById("kpiClosed").textContent = closed;
  document.getElementById("kpiProgress").textContent = progress;
}
document.querySelectorAll(".side-tab").forEach(tab => {
  tab.addEventListener("click", () => {
    const target = tab.dataset.tab;

    // active tab button
    document.querySelectorAll(".side-tab").forEach(t => t.classList.remove("active"));
    tab.classList.add("active");

    // active panel
    document.querySelectorAll(".tab-panel").forEach(p => p.classList.remove("active"));
    document.getElementById("tab-" + target).classList.add("active");
  });
});
let statusChartInstance = null;
let priorityChartInstance = null;

function normalizePriority(raw) {
  if (!raw) return "Medium";

  // SharePoint choice object
  if (typeof raw === "object" && raw.Value) {
    raw = raw.Value;
  }

  if (typeof raw !== "string") return "Medium";

  const p = raw.trim().toLowerCase();

  if (p === "low") return "Low";
  if (p === "medium") return "Medium";
  if (p === "high") return "High";
  if (p === "urgent") return "Urgent";

  return "Medium"; // fallback
}
function normalizeStatus(raw) {
  if (!raw) return "Received";

  // SharePoint Choice field object
  if (typeof raw === "object" && raw.Value) {
    return raw.Value;
  }

  // Normal string
  if (typeof raw === "string") {
    return raw;
  }

  return "Received";
}


function renderDashboardCharts() {
  if (!Array.isArray(tickets) || tickets.length === 0) return;

  /* ---------- STATUS DATA ---------- */
  const statusMap = {};
  tickets.forEach(t => {
    const status = normalizeStatus(t.status || t.Status);
    statusMap[status] = (statusMap[status] || 0) + 1;
  });

const statusLabels = STATUS_FLOW;
const statusValues = STATUS_FLOW.map(
  s => statusMap[s] || 0
);


  /* ---------- PRIORITY DATA ---------- */
const priorityMap = {
  Low: 0,
  Medium: 0,
  High: 0,
  Urgent: 0
};

tickets.forEach(t => {
  const prio = normalizePriority(t.priority || t.Priority);
  priorityMap[prio]++;
});


  /* ---------- DESTROY OLD ---------- */
  if (statusChartInstance) statusChartInstance.destroy();
  if (priorityChartInstance) priorityChartInstance.destroy();

  /* ---------- STATUS CHART ---------- */
  statusChartInstance = new Chart(
    document.getElementById("statusChart"),
    {
      type: "bar",
      data: {
        labels: statusLabels,
        datasets: [{
          data: statusValues,
          backgroundColor: "#2563eb"
        }]
      },
      options: { 
        indexAxis: "y",
        responsive: true,
        plugins: { legend: { display: false } }
      }
    }
  );

  /* ---------- PRIORITY CHART ---------- */
  priorityChartInstance = new Chart(
    document.getElementById("priorityChart"),
    {
      type: "doughnut",
      data: {
        labels: Object.keys(priorityMap),
        datasets: [{
          data: Object.values(priorityMap),
          backgroundColor: [
            "#22c55e",
            "#0ea5e9",
            "#f97316",
            "#ef4444"
          ]
        }]
      },
      options: { responsive: true }
    }
  );
}


function renderTicketModal(mode, ticket = {}) {
  const isCreate = mode === "create";

  document.getElementById("modalContent").innerHTML = `

    <div class="modal-header">
      <div>${isCreate ? "Create Ticket" : "Edit Ticket ‚Äî " + ticket.ticketRef}</div>
      <span class="modal-close" onclick="closeModal()">√ó</span>
    </div>

    <div class="modal-body"> 
     <!-- Repair Journey -->
<div id="repairJourney" style="margin-bottom:16px;"></div>

      <div class="modal-grid">

        <div>
          <label>Customer</label>
          <input id="m_customer" value="${ticket.customerName || ""}">
        </div>

        <div>
          <label>Contact</label>
          <input id="m_phone" value="${ticket.customerPhone || ""}">
        </div>

        <div class="full">
          <label>Issue</label>
          <textarea id="m_issue">${ticket.issue || ""}</textarea>
        </div>

        <div>
          <label>Component</label>
          <select id="m_component">
            ${["Pump","Valve","Cylinder"].map(c =>
              `<option ${ticket.componentType === c ? "selected" : ""}>${c}</option>`
            ).join("")}
          </select>
        </div>

        <div>
          <label>Serial</label>
          <input id="m_serial" value="${ticket.serial || ""}">
        </div>
        
        <div>
          <label>Model</label>
          <input id="m_model" value="${ticket.model || ""}">
        </div>

        <div>
          <label>Priority</label>
          <select id="m_priority">
            ${["Low","Medium","High","Urgent"].map(p =>
              `<option ${ticket.priority === p ? "selected" : ""}>${p}</option>`
            ).join("")}
          </select>
        </div>
        <div>
  <label>Status</label>
  <select id="m_status">
    ${[
      "Received",
      "Under Inspection",
      "Inspection Report/Quote Sent",
      "Approval/Order Received",
      "Spare Procurement",
      "Spare Availability",
      "In Repair",
      "Testing",
      "Billing",
      "Ready for Pickup",
      "Dispatched",
      "Closed"
    ].map(s =>
      `<option value="${s}" ${ticket.status === s ? "selected" : ""}>${s}</option>`
    ).join("")}
  </select>
</div>

    <div>
    <label>FD</label>
    <input id="m_fd" value="${ticket.fd || ""}">
    </div>
    <div>
    <label>MNR</label>
    <input id="m_mnr" value="${ticket.mnr || ""}">
    </div>

    <!-- üîΩ PASTE HERE üîΩ -->
    <button id="addAttachmentBtn" class="premium-attach-btn">
  <span class="attach-plus">+</span>
  <span>Add attachment</span>
</button>

    <input
      type="file"
      id="attachmentInput"
      multiple
      accept="image/*,video/*"
      style="display:none"
    />
    <div id="attachmentList" class="attachment-list"></div>
    <!-- üîº END üîº -->

      </div>
    </div>

    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal()">Cancel</button>
      <button class="btn btn-primary" onclick="submitTicketFromModal()">
        ${isCreate ? "Create Ticket" : "Save Changes"}
      </button>
    </div>
   
  <!-- ATTACHMENT PREVIEW SECTION -->
  <div class="attachment-preview">
    <strong>Attachments</strong>

    <div
      id="attachmentItems"
      style="margin-top:8px; font-size:14px;"
    >
      <em>Loading attachments‚Ä¶</em>
    </div>
  </div>
 `;
   
setTimeout(() => {

  const btn = document.getElementById("addAttachmentBtn");
  const input = document.getElementById("attachmentInput");
  const list = document.getElementById("attachmentList");

  if (!btn || !input || !list) return;

  btn.onclick = () => input.click();

  input.onchange = async () => {

    const files = Array.from(input.files || []);
    if (!files.length) return;

    for (const file of files) {

      const icon = getFileIcon(file.name);
      const fileURL = URL.createObjectURL(file);

      const row = document.createElement("div");
      row.className = "attachment-row";

      row.innerHTML = `
        <div style="display:flex;align-items:center;gap:8px;">
          ${icon}
          <span class="file-name" style="cursor:pointer;color:#2563eb;">
            ${file.name}
          </span>
        </div>

        <div>
          <span class="attachment-status">Uploading...</span>
          <span class="attach-action remove">üóë</span>
        </div>
      `;

      list.appendChild(row);

      const status = row.querySelector(".attachment-status");

      // PREVIEW
      row.querySelector(".file-name").onclick = () => {
        openAttachmentViewer(fileURL, file.name);
      };

      // REMOVE
      row.querySelector(".remove").onclick = () => {
        row.remove();
      };

      // ‚≠ê LIVE STATUS
      try {

        await uploadAttachmentViaFlow(selectedTicketId, file);

        status.innerText = "‚úì Uploaded";
        status.style.color = "green";

      } catch {

        status.innerText = "‚ùå Failed";
        status.style.color = "red";

      }

    }

    input.value = "";

  };

},0);

    // ===== ATTACHMENT HANDLING (DASHBOARD) =====
const modal = document.getElementById("modalContent");
const addAttachmentBtn = modal.querySelector("#addAttachmentBtn");
const attachmentInput = modal.querySelector("#attachmentInput");

if (addAttachmentBtn && attachmentInput) {
  addAttachmentBtn.onclick = () => {
    // Bind onchange right before opening picker (avoids stale DOM)
attachmentInput.onchange = () => {

  const files = Array.from(attachmentInput.files || []);
  if (!files.length) return;

  const previewBox = document.getElementById("attachmentPreview");

  files.forEach(file => {

    // store locally
    selectedFiles.push(file);

    const chip = document.createElement("div");
    chip.className = "attach-chip";

    chip.innerHTML = `
        <span class="attach-chip-name">${file.name}</span>
        <span class="attach-remove">‚ùå</span>
    `;

    // REMOVE FILE
    chip.querySelector(".attach-remove").onclick = () => {
        selectedFiles = selectedFiles.filter(f => f !== file);
        chip.remove();
    };

    previewBox.appendChild(chip);

  });

  attachmentInput.value = ""; // reset input
  };
 }
}
  /* const btn = document.getElementById("addAttachmentBtn");
  const input = document.getElementById("attachmentInput");
    console.log("LOCAL PRIORITY UPDATED ‚Üí", ticket.priority);

   if (btn && input) {
    btn.onclick = () => input.click();

input.onchange = async (e) => {
  const files = Array.from(e.target.files || []);
  if (!files.length || !selectedTicketId) return;

  btn.disabled = true;

  try {
    for (const file of files) {
      await uploadAttachmentToSharePoint(selectedTicketId, file);
    }

    alert("‚úÖ Attachment uploaded to SharePoint");
    loadRequestDigest();   // üî• CALL ONCE ONLY

    await loadTicketsFromSharePoint();
    const fresh = tickets.find(t => String(t.id) === String(selectedTicketId));
    renderTicketModal("edit", fresh);
    
  } catch (err) {
    console.error("ATTACHMENT ERROR:", err);
    alert("‚ùå Attachment upload failed");
  } finally {
    btn.disabled = false;
    input.value = "";
  }
};*/

  renderRepairJourney(ticket.status || "Received");

}
 const FLOW_URL = "https://default0ae51e1907c84e4bbb6d648ee58410.f4.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/63114f58823848588f703193943267cd/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=2SuOWBkHVLQ8Ohj1lpywbtM7-vq0ZUb1huR3kcDQPSo";
let tickets = [];
let selectedTicketId = null;

let modalMode = "edit"; // "create" | "edit"

document.getElementById("openCreateTicket").onclick = () => {
  modalMode = "create";
  selectedTicketId = null;
  openModal();
  renderTicketModal("create");
};

async function submitTicketFromModal() {
  const existing = tickets.find(t => String(t.id) === String(selectedTicketId)) || {};

  const payload = {
    action: modalMode === "create" ? "create" : "update",

    // REQUIRED FOR UPDATE
    id: modalMode === "edit" ? selectedTicketId : undefined,

    // NEVER LET TITLE GO EMPTY
    Title: modalMode === "create"
      ? generateTicketRef()
      : existing.ticketRef,

    // üîí SAFE FIELD MAPPING (NO MORE DATA LOSS)
    ComponentType: val("m_component", existing.componentType),
    Serial:        val("m_serial", existing.serial),
    Model:         val("m_model", existing.model),
    Issue:         val("m_issue", existing.issue),

    FD:            val("m_fd", existing.fd),
    MNR:           val("m_mnr", existing.mnr),

    Priority:
  modalMode === "create"
    ? val("prioritySelect", "Medium")
    : val("m_priority", existing.priority).toLowerCase(),

    Status:
  modalMode === "create"
    ? "Received"
    : normalizeStatus(
        val("m_status", normalizeStatus(existing.status))
      ),


    CustomerName:  val("m_customer", existing.customerName),
    CustomerEmail: val("m_email", existing.customerEmail),
    CustomerPhone: val("m_phone", existing.customerPhone)
  };

  console.log("FINAL PAYLOAD ‚Üí", payload);

  try {
     ledSending("Saving ticket...");
    const res = await fetch(FLOW_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    if (!res.ok) throw new Error(await res.text());

    closeModal();
    await loadTicketsFromSharePoint();
    ledSuccess("Ticket saved");
    alert("‚úÖ Ticket saved");

  } catch (e) {
    console.error("MODAL SUBMIT ERROR:", e);
    ledError("Ticket save failed");
    alert("‚ùå Update failed");
  }
}


async function openTicket(spId) {
  try {
    const res = await fetch(FLOW_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
      action: "getById",
      id: spId
      })
    });

    if (!res.ok) {
      const t = await res.text();
      throw new Error(t);
    }

    const item = await res.json();
     selectedTicket = {
  id: item.ID,
  ticketRef: item.Title,

  componentType: item.ComponentType || "",
  serial: item.Serial || "",
  model: item.Model || "",
  issue: item.Issue || "",

  fd: item.FD || "",
  mnr: item.MNR || "",

  priority: item.Priority
  ? item.Priority.charAt(0).toUpperCase() + item.Priority.slice(1)
  : "Medium",
  status: normalizeStatus(item.Status),

  customerName: item.CustomerName || "",
  customerEmail: item.CustomerEmail || "",
  customerPhone: item.CustomerPhone || "",

  attachments: item.Attachments || []
};

      
   //renderDetail();

  } catch (e) {
    console.error("DETAIL LOAD ERROR:", e);
    alert("Failed to load ticket details from SharePoint");
  }
}
function openModal() {
  document.getElementById("ticketModal").style.display = "flex";
}

function closeModal() {
  document.getElementById("ticketModal").style.display = "none";
}
if (modalMode === "edit") {
  const t = tickets.find(x => String(x.id) === String(selectedTicketId));
  if (t) {
    t.priority = normalizePriority(
      document.getElementById("m_priority")?.value
    );
  }
}

async function loadTicketsFromSharePoint() {
  try {
    ledSending("Syncing dashboard...");
    const res = await fetch(FLOW_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ action: "getAll" })
    });

    const rawText = await res.text();

    if (!rawText || !rawText.trim()) {
      throw new Error("Flow returned empty response");
    }

    let result;
    try {
      result = JSON.parse(rawText);
    } catch (err) {
      console.error("FLOW RAW RESPONSE ‚Üí", rawText);
      throw new Error("Flow did not return valid JSON");
    }

    if (!result.data) {
      console.error("FULL FLOW RESULT ‚Üí", result);
      throw new Error("Flow response missing 'data'");
    }

    console.log("FIRST ITEM FULL DUMP ‚Üí", result.data[0]);

    let items = result.data;

    if (typeof items === "string") {
      try { items = JSON.parse(items); }
      catch { items = []; }
    }

    if (!Array.isArray(items)) items = [];

    tickets = items.map(item => ({
      id: item.ID,
      ticketRef: item.Title,

      componentType: item.ComponentType || "",
      serial: item.Serial || "",
      model: item.Model || "",
      issue: item.Issue || "",

      fd: item.FD || "",
      mnr: item.MNR || "",
      priority: normalizePriority(item.Priority),

      
      status: item.Status?.Value || "Received",


      customerName: item.CustomerName || "",
      customerEmail: item.CustomerEmail || "",
      customerPhone: item.CustomerPhone || "",

      attachments: item.Attachments || []
    }));

    if (tickets.length) selectedTicketId = tickets[0].id;

    renderList();
    updateKPIs();
    renderDashboardCharts();
    ledSuccess("Dashboard synced");
  } catch (e) {
    console.error("LOAD ERROR:", e);
    alert("Failed to load tickets from SharePoint");
  }
}


const STATUS_FLOW = [
  "Received",
  "Under Inspection",
  "Inspection Report/Quote Sent",
  "Approval/Order Received",
  "Spare Procurement",
  "Spare Availability",
  "In Repair",
  "Testing",
  "Billing",
  "Ready for Pickup",
  "Dispatched",
  "Closed"
];

  const STORAGE_KEY = 'repairTickets_lightUI_v3_simpleJourney';
function renderRepairJourney(status) {
  const el = document.getElementById("repairJourney");
  if (!el) return;

  const currentIndex = STATUS_FLOW.indexOf(status);

  el.innerHTML = `
    <div class="repair-journey">
      ${STATUS_FLOW.map((s, i) => {
        let cls = "journey-step";
        if (i < currentIndex) cls += " done";
        else if (i === currentIndex) cls += " current";

        return `
          <div class="${cls}" title="${s}">
            <div class="journey-circle">
              ${i < currentIndex ? "‚úì" : i + 1}
            </div>
            <div>${s}</div>
          </div>
        `;
      }).join("")}
    </div>
  `;
}


  function loadTickets() {
    try {
      const data = localStorage.getItem(STORAGE_KEY);
      return data ? JSON.parse(data) : [];
    } catch { return []; }
  }
  function saveTickets(tickets) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(tickets));
  }

  function generateTicketRef() {
    const now = new Date();
    const y = now.getFullYear();
    const m = String(now.getMonth() + 1).padStart(2, '0');
    const d = String(now.getDate()).padStart(2, '0');
    const rand = Math.random().toString(36).slice(2, 6).toUpperCase();
    return `RT-${y}${m}${d}-${rand}`;
  }
  function niceDateTime(iso) {
    const d = new Date(iso);
    return isNaN(d) ? iso : d.toLocaleString();
  }
  function computeExpectedCompletion(priority) {
    const d = new Date();
    let days = 5;
    if (priority === 'low') days = 7;
    else if (priority === 'medium') days = 5;
    else if (priority === 'high') days = 3;
    else if (priority === 'urgent') days = 2;
    d.setDate(d.getDate() + days);
    return d.toISOString();
  }
  function getStatusIndex(status) { return STATUS_FLOW.indexOf(status); }
  function getPriorityClass(prio) {
  if (!prio) return 'prio-medium';

  // Handle SharePoint Choice object
  if (typeof prio === "object" && prio.Value) {
    prio = prio.Value;
  }

  // Final safety
  if (typeof prio !== "string") {
    return 'prio-medium';
  }

  return 'prio-' + prio.toLowerCase();
}

  function trackingSubtitle(status) {
    switch (status) {
      case 'Received': return 'Component received at service bay';
      case 'Under Inspection': return 'Technician inspecting issue';
      case 'Quote Sent': return 'Quotation shared with customer';
      case 'Approved': return 'Repair approved';
      case 'In Repair': return 'Repair work in progress';
      case 'Testing': return 'Testing & validation in progress';
      case 'Ready for Pickup': return 'Ready to handover';
      case 'Delivered': return 'Delivered to customer';
      case 'Closed': return 'Job completed & closed';
      default: return '';
    }
  }
function populateStatusFilter() {
  const select = document.getElementById("filterStatus");
  if (!select) return;

  select.innerHTML = `<option value="all">All</option>`;

  STATUS_FLOW.forEach(status => {
    const opt = document.createElement("option");
    opt.value = status;
    opt.textContent = status;
    select.appendChild(opt);
  });
}


  const filterStatusEl = document.getElementById('filterStatus');
  const filterTypeEl = document.getElementById('filterType');
  // üîπ Populate Status Filter dynamically
filterStatusEl.innerHTML = `<option value="all">All</option>`;

STATUS_FLOW.forEach(status => {
  const opt = document.createElement("option");
  opt.value = status;
  opt.textContent = status;
  filterStatusEl.appendChild(opt);
});

  const searchTextEl = document.getElementById('searchText');
  const ticketListEl = document.getElementById('ticketList');
  const ticketCountEl = document.getElementById('ticketCount');
  const ticketSummaryEl = document.getElementById('ticketSummary');
  const detailHintEl = document.getElementById('detailHint');
  const headerRefEl = document.getElementById('headerRef');
  const headerStatusEl = document.getElementById('headerStatus');
  const detailContentEl = document.getElementById('detailContent');
  const analyticsUpdatedEl = document.getElementById('analyticsUpdated');
  const avgCostValueEl = document.getElementById('avgCostValue');
  const partsTrendsEl = document.getElementById('partsTrends');

  const previewOverlay = document.getElementById('previewOverlay');
  const previewTitle = document.getElementById('previewTitle');
  const previewBody = document.getElementById('previewBody');
  const previewOpen = document.getElementById('previewOpen');
  const previewDownload = document.getElementById('previewDownload');
  const previewClose = document.getElementById('previewClose');

  let currentPreviewAttachment = null;

  function openPreview(att) {
    if (!att || !att.url) {
      alert('Preview works only for files attached in this browser session.');
      return;
    }
    currentPreviewAttachment = att;
    previewTitle.textContent = att.name;
    previewBody.innerHTML = '';
    if (att.kind === 'photo') {
      const img = document.createElement('img');
      img.src = att.url;
      previewBody.appendChild(img);
    } else {
      const vid = document.createElement('video');
      vid.src = att.url;
      vid.controls = true;
      vid.autoplay = true;
      previewBody.appendChild(vid);
    }
    previewOverlay.style.display = 'flex';
  }
  function closePreview() {
    previewOverlay.style.display = 'none';
    previewBody.innerHTML = '';
    currentPreviewAttachment = null;
  }
  previewClose.onclick = closePreview;
  previewOverlay.onclick = (e) => {
    if (e.target === previewOverlay) closePreview();
  };

  previewOpen.onclick = () => {
    if (!currentPreviewAttachment || !currentPreviewAttachment.url) return;
    window.open(currentPreviewAttachment.url, '_blank');
  };

  previewDownload.onclick = () => {
    if (!currentPreviewAttachment || !currentPreviewAttachment.url) return;
    const a = document.createElement('a');
    a.href = currentPreviewAttachment.url;
    a.download = currentPreviewAttachment.name || 'attachment';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
  };

  function sendNotification(ticket, newStatus) {
    const now = new Date().toISOString();
    ticket.notifications = ticket.notifications || [];
    ticket.notifications.push({
      time: now,
      status: newStatus,
      email: ticket.customerEmail || '',
      phone: ticket.customerPhone || ''
    });
  }

  function computeAnalytics() {
    const costs = tickets
      .map(t => (t.cost !== undefined && t.cost !== null ? Number(t.cost) : NaN))
      .filter(v => !isNaN(v) && v >= 0);
    if (!costs.length) avgCostValueEl.textContent = '‚Äî';
    else {
      const avgCost = costs.reduce((a, b) => a + b, 0) / costs.length;
      avgCostValueEl.textContent = '‚Çπ ' + avgCost.toFixed(0);
    }

    const counts = {};
    tickets.forEach(t => {
      if (!t.failedPart) return;
      const key = t.failedPart.trim().toLowerCase();
      if (!key) return;
      counts[key] = (counts[key] || 0) + 1;
    });

    partsTrendsEl.innerHTML = '';
    const entries = Object.entries(counts).sort((a, b) => b[1] - a[1]);
    if (!entries.length) {
      partsTrendsEl.innerHTML = '<div class="hint">No data yet.</div>';
    } else {
      entries.slice(0, 8).forEach(([name, count]) => {
        const row = document.createElement('div');
        row.className = 'parts-list-row';
        const label = name.replace(/\b\w/g, c => c.toUpperCase());
        row.innerHTML = `
          <span>${label}</span>
          <span class="hint">${count} job${count > 1 ? 's' : ''}</span>
        `;
        partsTrendsEl.appendChild(row);
      });
    }

    analyticsUpdatedEl.textContent = 'Updated ' + new Date().toLocaleTimeString();
  }

  function renderList() {
    const sFilter = filterStatusEl.value;
    const tFilter = filterTypeEl.value;
    const q = searchTextEl.value.trim().toLowerCase();

    const filtered = tickets.filter(t => {
      if (sFilter !== 'all' && t.status !== sFilter) return false;
      if (tFilter !== 'all' && t.componentType !== tFilter) return false;
      if (q) {
        const text = (
          t.ticketRef + ' ' + t.serial + ' ' + t.model + ' ' +
          t.issue + ' ' + (t.customerName || '')
        ).toLowerCase();
        if (!text.includes(q)) return false;
      }
      return true;
    });

    ticketListEl.innerHTML = '';
    ticketCountEl.textContent = filtered.length + ' items';

    const open = tickets.filter(t => t.status !== 'Closed').length;
    const closed = tickets.length - open;
    //ticketSummaryEl.textContent = `${tickets.length} total ¬∑ ${open} open ¬∑ ${closed} closed`;

    if (!filtered.length) {
      ticketListEl.innerHTML = '<div style="padding:8px;font-size:11px;color:#9ca3af;">No tickets. Create one above.</div>';
      computeAnalytics();
      return;
    }

    filtered.forEach(t => {
      if (t.attachments && Array.isArray(t.attachments)) {
        t.photoCount = t.attachments.filter(a => a.kind === 'photo').length;
        t.videoCount = t.attachments.filter(a => a.kind === 'video').length;
      } else {
        t.photoCount = t.photoCount || 0;
        t.videoCount = t.videoCount || 0;
      }
      const hasAttachments = (t.photoCount > 0) || (t.videoCount > 0);

      const div = document.createElement('div');
      div.className = 'ticket-item' + (t.id === selectedTicketId ? ' active' : '');
      div.onclick = () => {
  modalMode = "edit";
  selectedTicketId = t.id;
  openModal();
  const fresh = tickets.find(x => String(x.id) === String(t.id));
  renderTicketModal("edit", fresh);
};


      const top = document.createElement('div');
      top.className = 'ticket-top-row';
      top.innerHTML = `
        <div class="ticket-top-left">
          <span class="ticket-ref">${t.ticketRef}</span>
          ${hasAttachments ? '<span class="attach-badge" title="Has attachments">üìé</span>' : ''}
        </div>
        <span class="status-chip">${t.status}</span>
      `;

      const meta = document.createElement('div');
      meta.className = 'ticket-meta';
      meta.innerHTML = `
        <span>
          <span class="priority-dot ${getPriorityClass(t.priority)}"></span>
          ${t.componentType} ¬∑ ${t.serial || 'No serial'}
        </span>
        <span>${t.customerName || 'No customer'}</span>
      `;

      const issue = document.createElement('div');
      issue.className = 'ticket-issue';
      issue.textContent = (t.issue || '').slice(0, 70);

      div.appendChild(top);
      div.appendChild(meta);
      div.appendChild(issue);

      ticketListEl.appendChild(div);
    });

    computeAnalytics();
  }

  function renderTracking(ticket) {
    const idx = getStatusIndex(ticket.status);
    const eta = ticket.expectedCompletion ? niceDateTime(ticket.expectedCompletion).split(',')[0] : '-';

    let html = `<div class="tracking-card">
      <div class="tracking-header-row">
        <div class="tracking-title">Repair journey</div>
        <div class="tracking-eta">ETA: <strong>${eta}</strong></div>
      </div>
      <div class="tracking-steps">
    `;

    STATUS_FLOW.forEach((s, i) => {
      const done = i < idx;
      const current = i === idx;
      const stepClass = ['tracking-step', done ? 'done' : '', current ? 'current' : ''].join(' ');
      html += `
        <div class="${stepClass}">
          <div class="tracking-marker">
            <div class="tracking-circle">${done ? '‚úì' : ''}</div>
            ${i < STATUS_FLOW.length - 1 ? '<div class="tracking-line"></div>' : ''}
          </div>
          <div class="tracking-labels">
            <div class="tracking-label-main">${s}</div>
            <div class="tracking-label-sub">${trackingSubtitle(s)}</div>
          </div>
        </div>
      `;
    });

    html += '</div></div>';
    return html;
  }

  function renderDetail() {
    const ticket = tickets.find(t => t.id === selectedTicketId);
    if (!ticket) {
      detailHintEl.textContent = 'Select a ticket';
      headerRefEl.textContent = '‚Äî';
      headerStatusEl.textContent = '‚Äî';
      detailContentEl.innerHTML = '<div class="hint">No ticket selected. Click any ticket on the left.</div>';
      return;
    }

    ticket.attachments = ticket.attachments || [];
    ticket.photoCount = ticket.attachments.filter(a => a.kind === 'photo').length;
    ticket.videoCount = ticket.attachments.filter(a => a.kind === 'video').length;

    detailHintEl.textContent = ticket.ticketRef;
    headerRefEl.textContent = ticket.ticketRef;
    headerStatusEl.textContent = ticket.status;

 let html = `
 ${renderRepairJourney(ticket.status)}
 <div class="detail-grid">

  <div>
    <div class="detail-label">Component</div>
    <input class="detail-input" id="editComponent" value="${ticket.componentType || ''}">
  </div>

  <div>
    <div class="detail-label">Serial</div>
    <input class="detail-input" id="editSerial" value="${ticket.serial || ''}">
  </div>

  <div>
    <div class="detail-label">Model</div>
    <input class="detail-input" id="editModel" value="${ticket.model || ''}">
  </div>

  <div>
    <div class="detail-label">Priority</div>
    <select id="prioritySelect" class="detail-input">
      <option ${ticket.priority==="Low"?"selected":""}>Low</option>
      <option ${ticket.priority==="Medium"?"selected":""}>Medium</option>
      <option ${ticket.priority==="High"?"selected":""}>High</option>
    </select>
  </div>

  <div style="grid-column: 1 / -1;">
    <div class="detail-label">Issue</div>
    <textarea id="issueInput" class="detail-input" rows="3">${ticket.issue || ""}</textarea>
  </div>

  <div style="grid-column: 1 / -1;">
    <div class="detail-label">Failed part</div>
    <input id="failedPartInput" class="detail-input" value="${ticket.failedPart || ""}">
  </div>

  <div>
    <div class="detail-label">Status</div>
    <select id="statusSelect" class="detail-input">
      ${STATUS_FLOW.map(s => `<option ${s===ticket.status?"selected":""}>${s}</option>`).join("")}
    </select>
  </div>

  <div style="grid-column: 1 / -1; margin-top:12px;">
    <button id="saveBtn" class="primary-btn">üíæ Save changes</button>
  </div>

</div>
`;

   // html += renderTracking(ticket);

    const currentIdx = getStatusIndex(ticket.status);
    html += `
      <div class="detail-actions">
        <span class="detail-label">Updated by</span>
        <input id="updateByName" placeholder="Technician / user" style="max-width:150px;margin-bottom:0;" />
        <span class="detail-label">Status</span>
        <select id="detailStatusSelect" class="select-inline">
    `;
    STATUS_FLOW.forEach((s, i) => {
      if (i < currentIdx) return;
      const sel = s === ticket.status ? 'selected' : '';
      html += `<option ${sel}>${s}</option>`;
    });
    html += `
        </select>
        <button id="detailUpdateBtn" class="btn btn-primary btn-small">Save & notify</button>
      </div>
    `;

    html += `
      <div class="attachments-card">
        <div class="attachments-header">
          <span class="hint">Attachments (double-click chip to preview)</span>
          <button class="btn btn-ghost btn-small" id="attachmentsBtn">üìé Attachments</button>
        </div>
        <div class="hint" id="attachInfo"></div>
        <div id="attachList" class="attach-list"></div>
        <input type="file" id="attachmentsInput" accept="image/*,video/*" multiple style="display:none;" />
      </div>
    `;

    const history = (ticket.history || []).slice().sort((a,b)=>new Date(a.time)-new Date(b.time));
    const notifs = (ticket.notifications || []).slice().sort((a,b)=>new Date(a.time)-new Date(b.time));

    html += `
      <div class="bottom-row">
        <div class="timeline-card">
          <div class="hint" style="margin-bottom:4px;">Ticket timeline / audit log</div>
    `;
    if (!history.length) {
      html += '<div class="hint">No events yet.</div>';
    } else {
      history.forEach(ev => {
        const fromText = ev.fromStatus ? ` (from ${ev.fromStatus})` : '';
        const byText = ev.by ? ` ‚Äî By: ${ev.by}` : '';
        html += `
          <div class="timeline-item">
            <div class="timeline-time">${niceDateTime(ev.time)}</div>
            <div><strong>${ev.status}</strong>${fromText}${byText}</div>
          </div>
        `;
      });
    }
    html += '</div>';

    html += `
        <div class="notif-card">
          <div class="hint" style="margin-bottom:4px;">Customer notifications</div>
    `;
    if (!notifs.length) {
      html += '<div class="hint">No notifications sent yet.</div>';
    } else {
      notifs.forEach(n => {
        html += `
          <div class="notif-item">
            <div class="timeline-time">${niceDateTime(n.time)}</div>
            <div><strong>${n.status}</strong> shared with customer</div>
            <div class="hint">Email: ${n.email || '-'} ¬∑ Phone: ${n.phone || '-'}</div>
          </div>
        `;
      });
    }

    html += `
          <div style="margin-top:6px;display:flex;gap:6px;flex-wrap:wrap;">
            <button class="btn btn-ghost btn-small" id="sendEmailBtn">Open email</button>
            <button class="btn btn-ghost btn-small" id="copySmsBtn">Copy SMS text</button>
          </div>
        </div>
      </div>
    `;

    detailContentEl.innerHTML = html;

    const statusSelect = document.getElementById('detailStatusSelect');
    const updateBtn = document.getElementById('detailUpdateBtn');
    const sendEmailBtn = document.getElementById('sendEmailBtn');
    const copySmsBtn = document.getElementById('copySmsBtn');
    const updateByInput = document.getElementById('updateByName');
    const failedPartInput = document.getElementById('failedPartInput');
    const repairCostInput = document.getElementById('repairCostInput');

    const attachmentsBtn = document.getElementById('attachmentsBtn');
    const attachInfo = document.getElementById('attachInfo');
    const attachList = document.getElementById('attachList');
    const attachmentsInput = document.getElementById('attachmentsInput');

    function refreshAttachmentDerived() {
      ticket.photoCount = ticket.attachments.filter(a => a.kind === 'photo').length;
      ticket.videoCount = ticket.attachments.filter(a => a.kind === 'video').length;
    }

    function renderAttachInfo() {
      refreshAttachmentDerived();
      const photos = ticket.photoCount || 0;
      const videos = ticket.videoCount || 0;
      attachInfo.textContent = `Photos: ${photos} ¬∑ Videos: ${videos}`;

   

      ticket.attachments.forEach(att => {
        const chip = document.createElement('span');
        chip.className = 'attach-chip';
        chip.setAttribute('data-id', att.id);

        const icon = att.kind === 'photo' ? 'üì∑' : 'üé•';

        const nameSpan = document.createElement('span');
        nameSpan.className = 'attach-chip-name';
        nameSpan.title = att.name;
        nameSpan.textContent = `${icon} ${att.name}`;

        const removeSpan = document.createElement('span');
        removeSpan.className = 'attach-remove';
        removeSpan.textContent = '‚úñ';
        removeSpan.setAttribute('data-id', att.id);

        chip.appendChild(nameSpan);
        chip.appendChild(removeSpan);
        attachList.appendChild(chip);

        // preview on double-click
        chip.ondblclick = () => openPreview(att);
      });

      attachList.querySelectorAll('.attach-remove').forEach(btn => {
        btn.onclick = (e) => {
          e.stopPropagation();
          const id = btn.getAttribute('data-id');
          const toRemove = ticket.attachments.find(a => a.id === id);
          if (toRemove && toRemove.url) {
            URL.revokeObjectURL(toRemove.url);
          }
          ticket.attachments = ticket.attachments.filter(a => a.id !== id);
          refreshAttachmentDerived();
          saveTickets(tickets);
          renderAttachInfo();
          renderList();
        };
      });
    }

    renderAttachInfo();

    attachmentsBtn.onclick = () => {
      attachmentsInput.value = '';
      attachmentsInput.click();
    };

    attachmentsInput.onchange = e => {
      const files = Array.from(e.target.files || []);
      if (!files.length) return;
      ticket.attachments = ticket.attachments || [];
      files.forEach((f, idx) => {
        const kind = f.type.startsWith('video/') ? 'video' : 'photo';
        const url = URL.createObjectURL(f);
        ticket.attachments.push({
          id: 'att-' + Date.now() + '-' + idx,
          name: f.name,
          kind,
          url
        });
      });
      refreshAttachmentDerived();
      saveTickets(tickets);
      renderAttachInfo();
      renderList();
    };

    updateBtn.onclick = async () => {
  const newStatus = statusSelect.value;
  const oldStatus = ticket.status;
  const by = updateByInput.value.trim() || 'Unknown';

  if (!newStatus || newStatus === oldStatus) {
    alert("Status not changed");
    return;
  }

  // üîπ Update locally first (for fast UI)
  ticket.status = newStatus;

  ticket.history = ticket.history || [];
  ticket.history.push({
    time: new Date().toISOString(),
    status: newStatus,
    fromStatus: oldStatus,
    by: by,
    note: 'Status updated'
  });

  sendNotification(ticket, newStatus);

  // üîπ Send update to SharePoint
  try {
const payload = {
  action: "update",
  id: ticket.id,

  Priority: normalizePriority(
  document.getElementById("m_priority")?.value
),
  Status: ticket.status
};


    console.log("STATUS UPDATE PAYLOAD ‚Üí", payload);

    const res = await fetch(FLOW_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    if (!res.ok) {
      const t = await res.text();
      throw new Error(t);
    }
  
    // üîπ Reload from SharePoint
    await loadTicketsFromSharePoint();

    alert("‚úÖ Status updated in dashboard & SharePoint");

  } catch (e) {
    console.error("STATUS UPDATE ERROR:", e);
    alert("‚ùå Failed to update status in SharePoint");
  }
};

    sendEmailBtn.onclick = () => {
      const email = ticket.customerEmail || '';
      if (!email) { alert('No customer email for this ticket.'); return; }
      const subject = encodeURIComponent(`Update: Ticket ${ticket.ticketRef} is now ${ticket.status}`);
      const body = encodeURIComponent(
        `Dear ${ticket.customerName || 'Customer'},\n\n` +
        `Your component (${ticket.componentType}, Serial: ${ticket.serial || '-'}) ` +
        `ticket ${ticket.ticketRef} status has been updated to: ${ticket.status}.\n\n` +
        `Issue reported:\n${ticket.issue || '-'}\n\n` +
        `Thank you,\nService Team`
      );
      window.location.href = `mailto:${email}?subject=${subject}&body=${body}`;
    };

    copySmsBtn.onclick = async () => {
      const text = `Ticket ${ticket.ticketRef} for ${ticket.componentType} (Serial: ${ticket.serial || '-'}) status is now: ${ticket.status}.`;
      try {
        await navigator.clipboard.writeText(text);
        alert('SMS text copied. Paste in WhatsApp/SMS.');
      } catch {
        alert('Could not copy automatically. Text:\n\n' + text);
      }
    };
  
   const get = (id) => {
      const el = document.getElementById(id);
      if (!el) throw new Error("Missing element id: " + id);
      return el.value;
    } 
  };

  filterStatusEl.onchange = renderList;
  filterTypeEl.onchange = renderList;
  searchTextEl.oninput = renderList;
  document.getElementById('clearFiltersBtn').onclick = () => {
    filterStatusEl.value = 'all';
    filterTypeEl.value = 'all';
    searchTextEl.value = '';
    renderList();
  };

  loadTicketsFromSharePoint();
  populateStatusFilter();
/* ======================================================
   HEADER BUTTON ACTIONS ‚Äî FINAL FIX
   ====================================================== */

// EXPORT CSV
const exportBtn = document.getElementById("exportCsvBtn");
if (exportBtn) {
  exportBtn.onclick = () => {
    if (!Array.isArray(tickets) || tickets.length === 0) {
      alert("No data to export");
      return;
    }

    const headers = Object.keys(tickets[0]);
    let csv = headers.join(",") + "\n";

    tickets.forEach(t => {
      const row = headers.map(h =>
        `"${String(t[h] ?? "").replace(/"/g, '""')}"`
      );
      csv += row.join(",") + "\n";
    });

    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "repair_tickets.csv";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  };
}

// IMPORT CSV
const importBtn = document.getElementById("importCsvBtn");
if (importBtn) {
  importBtn.onclick = () => {
    const input = document.createElement("input");
    input.type = "file";
    input.accept = ".csv";

    input.onchange = () => {
      const file = input.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = () => {
        console.log("CSV imported:", reader.result);
        alert("CSV loaded successfully");
      };
      reader.readAsText(file);
    };

    input.click();
  };
}

// SETTINGS
const settingsBtn = document.getElementById("settingsBtn");
if (settingsBtn) {
  settingsBtn.onclick = () => {
    alert("Settings panel coming soon");
  };
}

// ===== ATTACHMENT UPLOAD HELPERS (PROVEN DEMO LOGIC) =====
const ATTACHMENT_FLOW_URL = "https://default0ae51e1907c84e4bbb6d648ee58410.f4.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/a80a0546e16f4e6b8593ef59fa7116af/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=LwVD0pAdv-D6C2p8N_ffTTZfJyMBH56zenQOsrLpMpw";

function fileToBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result.split(",")[1]);
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}
// ===== FETCH ATTACHMENTS (READ-ONLY) =====
async function fetchAttachmentsForTicket(ticketId) {

  const res = await fetch("https://default0ae51e1907c84e4bbb6d648ee58410.f4.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/33c3f19a7f1d4297b42a95f4cc8aed5c/triggers/manual/paths/invoke?api-version=1", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      ticketId: String(ticketId)
    })
  });

  const data = await res.json();

  return data.attachments || [];

}
async function loadAndRenderAttachments(ticketId) {

  const list = document.getElementById("attachmentList");
  if (!list) return;

  list.innerHTML = "Loading...";

  try {

    const files = await fetchAttachmentsForTicket(ticketId);

    list.innerHTML = "";

    if (!files.length) {
      list.innerHTML = "No attachments";
      return;
    }

    files.forEach(file => {

      const icon = getFileIcon(file.name);

      const row = document.createElement("div");
      row.className = "attachment-row";

      row.innerHTML = `
        <div style="display:flex;align-items:center;gap:8px;">
          ${icon}
          <span class="file-name" style="cursor:pointer;color:#2563eb;">
            ${file.name}
          </span>
          <span style="font-size:12px;color:#64748b;">
            ${formatFileSize(file.size)}
          </span>
        </div>
      `;

      list.appendChild(row);

      row.querySelector(".file-name").onclick = () => {
        openAttachmentViewer(file.url, file.name);
      };

    });

  } catch (err) {
    list.innerHTML = "Failed to load attachments";
  }
}

async function uploadAttachmentViaFlow(ticketId, file) {
  const base64 = await fileToBase64(file);

  const res = await fetch(ATTACHMENT_FLOW_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      ticketId: String(ticketId),
      fileName: file.name,
      fileContent: base64
    })
  });

  if (!res.ok) {
    const txt = await res.text();
    throw new Error("Flow upload failed: " + txt);
  }
}


</script>
<!-- Ticket Popup Modal -->
<div id="ticketModal" class="modal">
  <div class="modal-box">

    <div id="modalContent">

  <!-- existing ticket details will be rendered here -->

  <!-- ATTACHMENT UI (PHASE 1) -->
  <div class="attachment-section" style="margin-top:16px;">
    <button id="addAttachmentBtn" class="button-26">
      Add Attachment
    </button>

    <input
      type="file"
      id="attachmentInput"
      style="display:none"
      multiple
    />
  </div>

</div>

  </div>
</div>
</div> <!-- layout -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<!-- ===== Attachment Viewer Overlay ===== -->
<div id="attachmentViewer" class="viewer-overlay">
  <div class="viewer-content">
    <span class="viewer-close" onclick="closeAttachmentViewer()">√ó</span>
    <div id="viewerBody"></div>
  </div>
</div>


</body>
</html>